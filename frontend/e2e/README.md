# E2E æµ‹è¯•è¯´æ˜

## ğŸ“‹ æµ‹è¯•ç­–ç•¥

æœ¬é¡¹ç›®é‡‡ç”¨**å•ä¸€çœŸæ­£çš„ E2E æµ‹è¯•**ç­–ç•¥ï¼Œé¿å…"ä¼ª E2E"æµ‹è¯•é€ æˆæ··æ·†ã€‚

### æµ‹è¯•é‡‘å­—å¡”

```
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   E2E æµ‹è¯•        â”‚  â† å°‘é‡ï¼Œæµ‹è¯•å®Œæ•´æµç¨‹ï¼Œéœ€è¦çœŸå® API
        â”‚  (api-full-flow)  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â–²
              â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚   é›†æˆæµ‹è¯•         â”‚  â† ä¸­ç­‰ï¼Œæµ‹è¯• API ç«¯ç‚¹ï¼Œä½¿ç”¨ mock
      â”‚  (backend/tests/)  â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â–²
            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   å•å…ƒæµ‹è¯•           â”‚  â† å¤§é‡ï¼Œå¿«é€Ÿï¼Œç‹¬ç«‹
    â”‚ (å‰ç«¯ + åç«¯)        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ E2E æµ‹è¯•æ–‡ä»¶

### 1. **api-full-flow.spec.ts** â­ ä¸»è¦ E2E æµ‹è¯•

**ç‰¹ç‚¹**ï¼š
- âœ… çœŸæ­£çš„ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆå®Œæ•´æµç¨‹ï¼‰
- âœ… ä½¿ç”¨çœŸå®çš„ AI APIï¼ˆGoogle Geminiï¼‰
- âœ… æµ‹è¯•ä»åˆ›å»ºåˆ°å¯¼å‡ºçš„å®Œæ•´é“¾è·¯
- âœ… åœ¨ CI ä¸­è‡ªåŠ¨è¿è¡Œï¼ˆå¦‚æœé…ç½®äº† API keyï¼‰

**æµ‹è¯•æµç¨‹**ï¼š
```
1. åˆ›å»ºé¡¹ç›®ï¼ˆä»æƒ³æ³•/å¤§çº²/æè¿°ï¼‰
   â†“
2. ç­‰å¾… AI ç”Ÿæˆå¤§çº²
   â†“
3. ç”Ÿæˆé¡µé¢æè¿°
   â†“
4. ç”Ÿæˆé¡µé¢å›¾ç‰‡
   â†“
5. å¯¼å‡ºå›¾ç‰‡ ZIP
```

**è¿è¡Œæ¡ä»¶**ï¼š
- âš ï¸ éœ€è¦çœŸå®çš„ `GOOGLE_API_KEY`
- âš ï¸ éœ€è¦çº¦ 10-15 åˆ†é’Ÿ
- âš ï¸ ä¼šæ¶ˆè€— API é…é¢ï¼ˆçº¦ $0.01-0.05/æ¬¡ï¼‰

**æœ¬åœ°è¿è¡Œ**ï¼š
```bash
# 1. ç¡®ä¿ .env ä¸­é…ç½®äº†çœŸå®çš„ GOOGLE_API_KEY
# 2. å¯åŠ¨æœåŠ¡
docker compose up -d

# 3. ç­‰å¾…æœåŠ¡å°±ç»ªï¼ˆä½¿ç”¨æ™ºèƒ½ç­‰å¾…è„šæœ¬ï¼‰
./scripts/wait-for-health.sh http://localhost:5000/health 60 2
./scripts/wait-for-health.sh http://localhost:3000 60 2

# 4. è¿è¡Œæµ‹è¯•
npx playwright test api-full-flow.spec.ts --workers=1
```

**CI è¿è¡Œ**ï¼š
- è‡ªåŠ¨è¿è¡Œï¼šåœ¨ `docker-test` job ä¸­
- æ¡ä»¶ï¼š`GOOGLE_API_KEY` å·²åœ¨ GitHub Secrets ä¸­é…ç½®
- è·³è¿‡ï¼šå¦‚æœæ²¡æœ‰é…ç½® API keyï¼Œä¼šè·³è¿‡å¹¶æ˜¾ç¤ºè¯´æ˜

---

### 2. **ui-full-flow.spec.ts** ğŸ¨ UI é©±åŠ¨çš„å®Œæ•´æµ‹è¯•

**ç‰¹ç‚¹**ï¼š
- âœ… ä»æµè§ˆå™¨ UI å¼€å§‹æ“ä½œï¼ˆæ¨¡æ‹ŸçœŸå®ç”¨æˆ·ï¼‰
- âœ… æµ‹è¯•å®Œæ•´çš„ç”¨æˆ·äº¤äº’æµç¨‹
- âœ… éœ€è¦çœŸå®çš„ AI APIï¼ˆGoogle Geminiï¼‰
- âš ï¸ è¿è¡Œæ—¶é—´æ›´é•¿ï¼ˆ15-20 åˆ†é’Ÿï¼‰
- âœ… åœ¨ CI ä¸­è‡ªåŠ¨è¿è¡Œï¼ˆå¦‚æœæœ‰ API keyï¼‰

**ç”¨é€”**ï¼š
- å‘å¸ƒå‰çš„æœ€ç»ˆéªŒè¯
- éªŒè¯çœŸå®ç”¨æˆ·ä½“éªŒ
- CI/CD å®Œæ•´æµç¨‹æµ‹è¯•

**æœ¬åœ°è¿è¡Œ**ï¼š
```bash
# 1. ç¡®ä¿ .env ä¸­é…ç½®äº†çœŸå®çš„ GOOGLE_API_KEY
# 2. å¯åŠ¨æœåŠ¡
docker compose up -d

# 3. ç­‰å¾…æœåŠ¡å°±ç»ª
./scripts/wait-for-health.sh http://localhost:5000/health 60 2
./scripts/wait-for-health.sh http://localhost:3000 60 2

# 4. è¿è¡Œæµ‹è¯•
npx playwright test ui-full-flow.spec.ts --workers=1
```

**CI è¿è¡Œ**ï¼š
- è‡ªåŠ¨è¿è¡Œï¼šåœ¨ `docker-test` job ä¸­
- æ¡ä»¶ï¼š`GOOGLE_API_KEY` å·²åœ¨ GitHub Secrets ä¸­é…ç½®
- è·³è¿‡ï¼šå¦‚æœæ²¡æœ‰é…ç½® API key æˆ–æ˜¯ Fork PRï¼Œä¼šè·³è¿‡å¹¶æ˜¾ç¤ºè¯´æ˜

---

## ğŸš« å·²åˆ é™¤çš„æµ‹è¯•

ä»¥ä¸‹æµ‹è¯•æ–‡ä»¶å·²è¢«åˆ é™¤ï¼ˆé¿å…æ··æ·†ï¼‰ï¼š

- ~~`home.spec.ts`~~ - åŸºç¡€ UI æµ‹è¯•ï¼ˆä¸æ˜¯çœŸæ­£çš„ E2Eï¼‰
- ~~`create-images.spec.ts`~~ - API é›†æˆæµ‹è¯•ï¼ˆä¸æ˜¯çœŸæ­£çš„ E2Eï¼‰

**åŸå› **ï¼š
- å®ƒä»¬ä¸è°ƒç”¨çœŸå® AI APIï¼Œä¸æ˜¯çœŸæ­£çš„ç«¯åˆ°ç«¯æµ‹è¯•
- æµ‹è¯•çš„å†…å®¹å·²è¢«å…¶ä»–æµ‹è¯•è¦†ç›–ï¼š
  - UI äº¤äº’ â†’ å‰ç«¯å•å…ƒæµ‹è¯•
  - API ç«¯ç‚¹ â†’ åç«¯é›†æˆæµ‹è¯•
  - å®Œæ•´æµç¨‹ â†’ `api-full-flow.spec.ts`

---

## ğŸ”§ CI é…ç½®

### åœ¨ GitHub Actions ä¸­çš„è¿è¡Œé€»è¾‘

```yaml
# .github/workflows/ci-test.yml

docker-test job:
  â”œâ”€ æ„å»º Docker é•œåƒ
  â”œâ”€ å¯åŠ¨æœåŠ¡
  â”œâ”€ å¥åº·æ£€æŸ¥
  â”œâ”€ Docker ç¯å¢ƒæµ‹è¯•
  â””â”€ E2E æµ‹è¯• (api-full-flow.spec.ts)
      â”œâ”€ å¦‚æœæœ‰ GOOGLE_API_KEY â†’ è¿è¡Œå®Œæ•´ E2E
      â””â”€ å¦‚æœæ²¡æœ‰ API key â†’ è·³è¿‡ï¼Œæ˜¾ç¤ºè¯´æ˜
```

### é…ç½® GitHub Secrets

è¦åœ¨ CI ä¸­è¿è¡Œ E2E æµ‹è¯•ï¼Œéœ€è¦é…ç½®ï¼š

1. è¿›å…¥ä»“åº“ â†’ **Settings** â†’ **Secrets and variables** â†’ **Actions**
2. æ·»åŠ  Secretï¼š
   - Name: `GOOGLE_API_KEY`
   - Value: ä½ çš„ Google Gemini API å¯†é’¥
   - è·å–åœ°å€ï¼šhttps://aistudio.google.com/app/apikey

### å¦‚æœæ²¡æœ‰é…ç½® API key

CI ä¼šè·³è¿‡ E2E æµ‹è¯•ï¼Œå¹¶æ˜¾ç¤ºï¼š

```
âš ï¸  Skipping E2E tests

Reason: GOOGLE_API_KEY not configured or using mock key

Note: Other tests already passed:
  âœ… Backend unit tests
  âœ… Backend integration tests (with mock AI)
  âœ… Frontend unit tests
  âœ… Docker environment tests

E2E tests require a real Google API key to test the complete AI generation workflow.
```

**è¿™æ˜¯æ­£å¸¸çš„ï¼** å…¶ä»–æµ‹è¯•å·²ç»è¦†ç›–äº†å¤§éƒ¨åˆ†åŠŸèƒ½ã€‚

---

## ğŸ“Š æµ‹è¯•è¦†ç›–èŒƒå›´

| æµ‹è¯•å±‚çº§ | æµ‹è¯•å†…å®¹ | éœ€è¦çœŸå® API | è¿è¡Œæ—¶é—´ | CI è¿è¡Œ |
|---------|---------|-------------|---------|---------|
| **å‰ç«¯å•å…ƒæµ‹è¯•** | React ç»„ä»¶ã€hooksã€å·¥å…·å‡½æ•° | âŒ | < 1 åˆ†é’Ÿ | âœ… æ€»æ˜¯ |
| **åç«¯å•å…ƒæµ‹è¯•** | Servicesã€Utilsã€Models | âŒ | < 2 åˆ†é’Ÿ | âœ… æ€»æ˜¯ |
| **åç«¯é›†æˆæµ‹è¯•** | API ç«¯ç‚¹ï¼ˆmock AIï¼‰ | âŒ | < 3 åˆ†é’Ÿ | âœ… æ€»æ˜¯ |
| **Docker ç¯å¢ƒæµ‹è¯•** | å®¹å™¨å¯åŠ¨ã€å¥åº·æ£€æŸ¥ | âŒ | < 5 åˆ†é’Ÿ | âœ… æ€»æ˜¯ |
| **E2E æµ‹è¯•** | å®Œæ•´ AI ç”Ÿæˆæµç¨‹ | âœ… | 10-15 åˆ†é’Ÿ | âš ï¸ æœ‰ API key æ—¶ |

---

## ğŸ¯ æœ€ä½³å®è·µ

### å¼€å‘æ—¶

1. **æ—¥å¸¸å¼€å‘**ï¼šè¿è¡Œå•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
   ```bash
   # åç«¯
   cd backend && uv run pytest tests/
   
   # å‰ç«¯
   cd frontend && npm test
   ```

2. **æäº¤ PR å‰**ï¼šç¡®ä¿ CI çš„æ‰€æœ‰æµ‹è¯•é€šè¿‡
   - Light Checkï¼ˆè‡ªåŠ¨è¿è¡Œï¼‰
   - Full Testï¼ˆæ·»åŠ  `ready-for-test` æ ‡ç­¾è§¦å‘ï¼‰

3. **å¤§åŠŸèƒ½å®Œæˆå**ï¼šæœ¬åœ°è¿è¡Œä¸€æ¬¡ E2E æµ‹è¯•
   ```bash
   # ç¡®ä¿ .env é…ç½®äº†çœŸå® API key
   npx playwright test api-full-flow.spec.ts
   ```

### å‘å¸ƒå‰

1. **æœ€ç»ˆéªŒè¯**ï¼šè¿è¡Œå®Œæ•´çš„ UI E2E æµ‹è¯•
   ```bash
   npx playwright test ui-full-flow.spec.ts
   ```

2. **æ£€æŸ¥ CI**ï¼šç¡®ä¿æ‰€æœ‰æµ‹è¯•ï¼ˆåŒ…æ‹¬ E2Eï¼‰éƒ½é€šè¿‡

---

## ğŸ› è°ƒè¯•å¤±è´¥çš„æµ‹è¯•

### æŸ¥çœ‹æµ‹è¯•æŠ¥å‘Š

```bash
# è¿è¡Œæµ‹è¯•åï¼Œæ‰“å¼€ HTML æŠ¥å‘Š
npx playwright show-report
```

### æŸ¥çœ‹å¤±è´¥æˆªå›¾å’Œè§†é¢‘

æµ‹è¯•å¤±è´¥æ—¶ï¼ŒPlaywright ä¼šè‡ªåŠ¨ä¿å­˜ï¼š
- æˆªå›¾ï¼š`test-results/**/test-failed-*.png`
- è§†é¢‘ï¼š`test-results/**/video.webm`
- è¿½è¸ªï¼š`test-results/**/trace.zip`

### æŸ¥çœ‹è¿½è¸ª

```bash
npx playwright show-trace test-results/**/trace.zip
```

### UI æ¨¡å¼è°ƒè¯•

```bash
# åœ¨ UI æ¨¡å¼ä¸‹è¿è¡Œæµ‹è¯•ï¼ˆå¯ä»¥çœ‹åˆ°æµè§ˆå™¨æ“ä½œè¿‡ç¨‹ï¼‰
npx playwright test --ui
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Playwright æ–‡æ¡£](https://playwright.dev)
- [CI é…ç½®è¯´æ˜](../.github/CI_SETUP.md)
- [é¡¹ç›® README](../README.md)

---

**æœ€åæ›´æ–°**: 2025-12-22  
**æµ‹è¯•ç­–ç•¥**: å•ä¸€çœŸæ­£çš„ E2E æµ‹è¯•
